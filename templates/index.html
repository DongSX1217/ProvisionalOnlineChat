<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ˜“åœ¨çº¿èŠå¤©å®¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        header {
            background: linear-gradient(90deg, #4b6cb7, #182848);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }
        
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chat-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
        }
        
        .message {
            background: white;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
        }
        
        .username {
            font-weight: bold;
            color: #4b6cb7;
            font-size: 0.95rem;
        }
        
        .ip-address {
            font-size: 0.8rem;
            color: #777;
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: #999;
            margin-top: 3px;
        }
        
        .message-content {
            font-size: 1rem;
            line-height: 1.5;
            margin: 8px 0;
            word-wrap: break-word;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 250px;
            border-radius: 8px;
            margin-top: 8px;
            display: block;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .input-area {
            padding: 15px;
            background-color: white;
            border-top: 1px solid #e0e0e0;
        }
        
        .input-group {
            display: flex;
            margin-bottom: 12px;
        }
        
        .input-group input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            border-color: #4b6cb7;
            outline: none;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
        }
        
        .message-input {
            display: flex;
            margin-bottom: 12px;
        }
        
        .message-input textarea {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            resize: none;
            height: 90px;
            transition: border-color 0.3s;
        }
        
        .message-input textarea:focus {
            border-color: #4b6cb7;
            outline: none;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
        }
        
        .buttons {
            display: flex;
            gap: 8px;
        }
        
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .send-btn {
            background: linear-gradient(90deg, #4b6cb7, #182848);
            color: white;
            flex: 1;
        }
        
        .send-btn:hover {
            background: linear-gradient(90deg, #3a5ca5, #121f3d);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }
        
        .image-btn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            color: white;
        }
        
        .image-btn:hover {
            background: linear-gradient(90deg, #009a87, #7db02f);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 176, 155, 0.4);
        }
        
        .emoji-btn {
            background: linear-gradient(90deg, #ff9966, #ff5e62);
            color: white;
        }
        
        .emoji-btn:hover {
            background: linear-gradient(90deg, #ff8a50, #ff4c52);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 94, 98, 0.4);
        }
        
        .emoji-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px;
            background-color: #f9f9f9;
            border-radius: 8px;
            margin-top: 8px;
            max-height: 130px;
            overflow-y: auto;
            display: none;
        }
        
        .emoji {
            font-size: 1.3rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .emoji:hover {
            transform: scale(1.2);
        }
        
        .image-preview {
            display: none;
            margin-top: 8px;
            text-align: center;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 130px;
            border-radius: 8px;
        }
        
        .remove-image {
            color: #ff5e62;
            cursor: pointer;
            margin-top: 4px;
            display: inline-block;
            font-size: 0.9rem;
        }
        
        .error-message {
            color: #ff5e62;
            text-align: center;
            padding: 8px;
            display: none;
            font-size: 0.9rem;
        }
        
        .info-bar {
            background-color: rgba(75, 108, 183, 0.1);
            padding: 8px;
            border-radius: 8px;
            margin-bottom: 12px;
            text-align: center;
            font-size: 0.85rem;
            color: #4b6cb7;
        }
        
        .typing-indicator {
            color: #777;
            font-style: italic;
            margin-bottom: 8px;
            height: 18px;
            font-size: 0.9rem;
        }
        
        .scroll-anchor {
            height: 1px;
            width: 100%;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 94, 98, 0.1);
            color: #ff5e62;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            padding: 0;
        }
        
        .delete-btn:hover {
            background: rgba(255, 94, 98, 0.2);
            transform: scale(1.1);
        }
        
        .notification-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        @media (max-width: 600px) {
            .container {
                height: 95vh;
            }
            
            header {
                padding: 12px;
            }
            
            header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            header p {
                font-size: 0.8rem;
            }
            
            .chat-container {
                padding: 10px;
            }
            
            .message {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .input-area {
                padding: 12px;
            }
            
            .input-group, .message-input {
                flex-direction: column;
                gap: 8px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
            
            .message-input textarea {
                height: 80px;
            }
            
            .delete-btn {
                top: 8px;
                right: 8px;
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç®€æ˜“ä¸´æ—¶åœ¨çº¿èŠå¤©å®¤</h1>
            <p>æ— éœ€æ³¨å†Œï¼Œéšæ—¶ç•…èŠ â€¢ æ˜¾ç¤ºç”¨æˆ·IP â€¢ æ”¯æŒå›¾ç‰‡å’Œè¡¨æƒ…</p>
            <button class="notification-btn" id="notificationBtn">ğŸ”” é€šçŸ¥</button>
        </header>
        
        <div class="info-bar">
            æ³¨æ„ï¼šæœ¬èŠå¤©å®¤ä»…ä¿ç•™æœ€è¿‘100æ¡æ¶ˆæ¯ â€¢ å›¾ç‰‡é™åˆ¶2MBä»¥å†… â€¢ æ–°æ¶ˆæ¯åœ¨åº•éƒ¨<br>ä»…ä¾›ä¸ªäººå­¦ä¹ äº¤æµä½¿ç”¨ï¼Œæµ‹è¯•ä¸­ï¼Œä»…å—é‚€è¯·è€…å…è®¸ä½¿ç”¨ï¼Œä¸¥ç¦å…¬å¼€æœåŠ¡å™¨IPï¼Œä¸¥ç¦å‘å¸ƒè¿æ³•å†…å®¹ï¼Œä¸¥ç¦æ•…æ„æŸåæœåŠ¡å™¨ï¼
        </div>
        
        <div class="chat-container" id="chatContainer">
            <div class="typing-indicator" id="typingIndicator"></div>
            <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
            <div id="scrollAnchor"></div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="input-area">
            <div class="input-group">
                <input type="text" id="username" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å (é»˜è®¤ä¸ºåŒ¿å)" maxlength="20">
            </div>
            
            <div class="message-input">
                <textarea id="message" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..."></textarea>
            </div>
            
            <div class="emoji-container" id="emojiContainer">
                <!-- Emojis will be added here by JavaScript -->
            </div>
            
            <div class="image-preview" id="imagePreview">
                <img id="previewImage" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                <div class="remove-image" id="removeImage">ç§»é™¤å›¾ç‰‡</div>
            </div>
            
            <div class="buttons">
                <button class="emoji-btn" id="emojiBtn">ğŸ˜€ è¡¨æƒ…</button>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button class="image-btn" id="imageBtn">ğŸ–¼ï¸ å›¾ç‰‡</button>
                <button class="send-btn" id="sendBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <script>
        // å¸¸ç”¨emojiåˆ—è¡¨
        const emojis = ["ğŸ˜€", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜", "ğŸ˜†", "ğŸ˜…", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜Š", "ğŸ˜‡", 
                        "ğŸ™‚", "ğŸ™ƒ", "ğŸ˜‰", "ğŸ˜Œ", "ğŸ˜", "ğŸ¥°", "ğŸ˜˜", "ğŸ˜—", "ğŸ˜™", "ğŸ˜š", 
                        "ğŸ˜‹", "ğŸ˜›", "ğŸ˜", "ğŸ˜œ", "ğŸ¤ª", "ğŸ¤¨", "ğŸ§", "ğŸ¤“", "ğŸ˜", "ğŸ¤©", 
                        "ğŸ¥³", "ğŸ˜", "ğŸ˜’", "ğŸ˜", "ğŸ˜”", "ğŸ˜Ÿ", "ğŸ˜•", "ğŸ™", "â˜¹ï¸", "ğŸ˜£", 
                        "ğŸ˜–", "ğŸ˜«", "ğŸ˜©", "ğŸ¥º", "ğŸ˜¢", "ğŸ˜­", "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¬", 
                        "ğŸ¤¯", "ğŸ˜³", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜±", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜“", "ğŸ¤—", 
                        "ğŸ¤”", "ğŸ¤­", "ğŸ¤«", "ğŸ¤¥", "ğŸ˜¶", "ğŸ˜", "ğŸ˜‘", "ğŸ˜¬", "ğŸ™„", "ğŸ˜¯", 
                        "ğŸ˜¦", "ğŸ˜§", "ğŸ˜®", "ğŸ˜²", "ğŸ¥±", "ğŸ˜´", "ğŸ¤¤", "ğŸ˜ª", "ğŸ˜µ", "ğŸ¤", 
                        "ğŸ¥´", "ğŸ¤¢", "ğŸ¤®", "ğŸ¤§", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤‘", "ğŸ¤ ", "ğŸ˜ˆ"];
        
        // DOMå…ƒç´ 
        const chatContainer = document.getElementById('chatContainer');
        const usernameInput = document.getElementById('username');
        const messageInput = document.getElementById('message');
        const sendBtn = document.getElementById('sendBtn');
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiContainer = document.getElementById('emojiContainer');
        const imageBtn = document.getElementById('imageBtn');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImage = document.getElementById('previewImage');
        const removeImage = document.getElementById('removeImage');
        const errorMessage = document.getElementById('errorMessage');
        const typingIndicator = document.getElementById('typingIndicator');
        const scrollAnchor = document.getElementById('scrollAnchor');
        const notificationBtn = document.getElementById('notificationBtn');
        
        // å½“å‰é€‰ä¸­çš„å›¾ç‰‡
        let selectedImage = null;
        
        // æ¶ˆæ¯IDè®¡æ•°å™¨ï¼ˆç”¨äºè·Ÿè¸ªå·²æ˜¾ç¤ºçš„æ¶ˆæ¯ï¼‰
        let lastMessageId = 0;
        
        // ç”¨æˆ·IPåœ°å€
        let userIP = '';
        
        // é€šçŸ¥æƒé™çŠ¶æ€
        let notificationPermission = false;
        
        // å¡«å……emojiå®¹å™¨
        function populateEmojis() {
            emojiContainer.innerHTML = '';
            emojis.forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji';
                span.textContent = emoji;
                span.onclick = () => {
                    messageInput.value += emoji;
                    messageInput.focus();
                };
                emojiContainer.appendChild(span);
            });
        }
        
        // æ˜¾ç¤º/éšè—emojié€‰æ‹©å™¨
        emojiBtn.addEventListener('click', () => {
            if (emojiContainer.style.display === 'flex') {
                emojiContainer.style.display = 'none';
            } else {
                populateEmojis();
                emojiContainer.style.display = 'flex';
            }
        });
        
        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        imageBtn.addEventListener('click', () => {
            imageUpload.click();
        });
        
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
                if (!validTypes.includes(file.type)) {
                    showError('åªæ”¯æŒJPEGã€PNGæˆ–GIFæ ¼å¼çš„å›¾ç‰‡');
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                if (file.size > 2 * 1024 * 1024) {
                    showError('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB');
                    return;
                }
                
                // é¢„è§ˆå›¾ç‰‡
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewImage.src = event.target.result;
                    imagePreview.style.display = 'block';
                    selectedImage = file;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // ç§»é™¤å›¾ç‰‡
        removeImage.addEventListener('click', () => {
            previewImage.src = '';
            imagePreview.style.display = 'none';
            imageUpload.value = '';
            selectedImage = null;
        });
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }
        
        // è¯·æ±‚é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                showError("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒé€šçŸ¥åŠŸèƒ½");
                return;
            }
            
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    notificationPermission = true;
                    notificationBtn.textContent = "ğŸ”” å·²å¯ç”¨";
                    showError("é€šçŸ¥åŠŸèƒ½å·²å¯ç”¨");
                } else {
                    notificationPermission = false;
                    notificationBtn.textContent = "ğŸ”• é€šçŸ¥";
                    showError("é€šçŸ¥åŠŸèƒ½è¢«æ‹’ç»");
                }
            });
        }
        
        // å‘é€é€šçŸ¥
        function sendNotification(title, body) {
            if (!notificationPermission) return;
            
            if (document.visibilityState !== 'visible') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'https://cdn-icons-png.flaticon.com/512/733/733585.png'
                });
                
                notification.onclick = () => {
                    window.focus();
                };
            }
        }
        
        // åˆå§‹åŒ–é€šçŸ¥æŒ‰é’®
        notificationBtn.addEventListener('click', requestNotificationPermission);
        
        // å‘é€æ¶ˆæ¯
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        function sendMessage() {
            const username = usernameInput.value.trim() || 'åŒ¿å';
            const message = messageInput.value.trim();
            
            // å¦‚æœæ²¡æœ‰æ¶ˆæ¯å’Œå›¾ç‰‡
            if (!message && !selectedImage) {
                showError('æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // åˆ›å»ºFormDataå¯¹è±¡
            const formData = new FormData();
            formData.append('username', username);
            formData.append('message', message);
            if (selectedImage) {
                formData.append('image', selectedImage);
            }
            
            // å‘é€è¯·æ±‚
            fetch('/send_message', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // æ¸…ç©ºè¾“å…¥
                    messageInput.value = '';
                    imageUpload.value = '';
                    previewImage.src = '';
                    imagePreview.style.display = 'none';
                    selectedImage = null;
                    
                    // è·å–æœ€æ–°æ¶ˆæ¯
                    fetchMessages(true);
                } else {
                    showError(data.message || 'å‘é€æ¶ˆæ¯å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showError('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™');
            });
        }
        
        // è·å–æ¶ˆæ¯
        function fetchMessages(scrollToBottom = false) {
            fetch('/get_messages')
            .then(response => response.json())
            .then(data => {
                if (data.messages && Array.isArray(data.messages)) {
                    // å­˜å‚¨ç”¨æˆ·IPï¼ˆç¬¬ä¸€æ¬¡è·å–æ—¶ï¼‰
                    if (!userIP && data.messages.length > 0) {
                        userIP = data.messages[0].ip || '';
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
                    const newMessages = data.messages.filter(msg => msg.sort_key > lastMessageId);
                    
                    // å¦‚æœæœ‰æ–°æ¶ˆæ¯ä¸”ä¸æ˜¯è‡ªå·±å‘é€çš„ï¼Œå‘é€é€šçŸ¥
                    if (newMessages.length > 0 && notificationPermission) {
                        const nonSelfMessages = newMessages.filter(msg => msg.ip !== userIP);
                        if (nonSelfMessages.length > 0) {
                            const sender = nonSelfMessages[0].username;
                            const content = nonSelfMessages[0].message ? 
                                nonSelfMessages[0].message.substring(0, 30) + (nonSelfMessages[0].message.length > 30 ? '...' : '') : 
                                'å‘é€äº†ä¸€å¼ å›¾ç‰‡';
                            
                            sendNotification('æ–°æ¶ˆæ¯', `${sender}: ${content}`);
                        }
                    }
                    
                    renderMessages(data.messages, scrollToBottom);
                }
            })
            .catch(error => {
                console.error('è·å–æ¶ˆæ¯å¤±è´¥:', error);
            });
        }
        
        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages(messages, scrollToBottom = false) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
            const newMessages = messages.filter(msg => msg.sort_key > lastMessageId);
            
            if (newMessages.length === 0) {
                return; // æ²¡æœ‰æ–°æ¶ˆæ¯ï¼Œä¸éœ€è¦æ›´æ–°
            }
            
            // æ›´æ–°æœ€åçš„æ¶ˆæ¯ID
            lastMessageId = Math.max(...messages.map(msg => msg.sort_key));
            
            // æ·»åŠ æ–°æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨ï¼ˆåœ¨æ»šåŠ¨é”šç‚¹ä¹‹å‰ï¼‰
            newMessages.forEach(msg => {
                const messageElement = createMessageElement(msg);
                scrollAnchor.insertAdjacentElement('beforebegin', messageElement);
            });
            
            // ç§»é™¤è¶…å‡º100æ¡çš„æ¶ˆæ¯ï¼ˆåªä¿ç•™æœ€è¿‘çš„100æ¡ï¼‰
            const allMessages = chatContainer.querySelectorAll('.message');
            if (allMessages.length > 100) {
                for (let i = 0; i < allMessages.length - 100; i++) {
                    allMessages[i].remove();
                }
            }
            
            // å¦‚æœéœ€è¦æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå‘é€æ–°æ¶ˆæ¯åï¼‰
            if (scrollToBottom) {
                scrollToBottomSmooth();
            }
        }
        
        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        function createMessageElement(msg) {
            const div = document.createElement('div');
            div.className = 'message';
            div.setAttribute('data-id', msg.sort_key);
            div.innerHTML = `
                <div class="message-header">
                    <span class="username">${escapeHtml(msg.username)}</span>
                    <span class="ip-address">IP: ${msg.ip}</span>
                    <span class="timestamp">${msg.timestamp}</span>
                </div>
                ${msg.message ? `<div class="message-content">${escapeHtml(msg.message).replace(/\n/g, '<br>')}</div>` : ''}
                ${msg.image ? `<img src="${msg.image}" alt="å›¾ç‰‡" class="message-image">` : ''}
            `;
            
            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œæ·»åŠ åˆ é™¤æŒ‰é’®
            if (msg.ip === userIP) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'æ’¤å›æ¶ˆæ¯';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.onclick = () => deleteMessage(msg.sort_key);
                div.appendChild(deleteBtn);
            }
            
            return div;
        }
        
        // åˆ é™¤æ¶ˆæ¯
        function deleteMessage(messageId) {
            if (!confirm('ç¡®å®šè¦æ’¤å›è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) return;
            
            fetch('/delete_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message_id: messageId,
                    ip: userIP
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // ä»DOMä¸­ç§»é™¤æ¶ˆæ¯
                    const messageElement = document.querySelector(`.message[data-id="${messageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                } else {
                    showError(data.message || 'æ’¤å›æ¶ˆæ¯å¤±è´¥');
                }
            })
            .catch(error => {
                console.error('æ’¤å›æ¶ˆæ¯å‡ºé”™:', error);
                showError('æ’¤å›æ¶ˆæ¯æ—¶å‡ºé”™');
            });
        }
        
        // å¹³æ»‘æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottomSmooth() {
            scrollAnchor.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ç®€å•çš„HTMLè½¬ä¹‰ï¼Œé˜²æ­¢XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // åˆå§‹åŠ è½½æ¶ˆæ¯
        fetchMessages(true);
        
        // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡æ¶ˆæ¯ï¼ˆä¸ä¼šå¼ºåˆ¶æ»šåŠ¨ï¼‰
        setInterval(() => fetchMessages(), 5000);
    </script>
</body>
</html>